<div class="container">

  <div class="headline">
    <h1>Upload a Model</h1>
  </div>

  <%= form_for :model, :url => {:action => :create},
    :html => {:onsubmit=>"return validateForm();", :multipart=>true,
      :id=>"model_form"} do |f| %>

    <div class="row">
      <div class="span6">
        <h2> Properties </h2>
        <span><strong>Name</strong></span>
        <br/>
        <%= f.text_field :name,
          {:class=>"model_text span6", :placeholder=>"Type model name here...",
           :required=>true} %>

        <br/>
        <span><strong>Description</strong></span>
        <br/>
        <%= f.text_area :description,
          {:class=>"field span6 upload",
            :placeholder=>"Add a brief description of your model...",
            :required=>true} %>
        <br/>
        <span> <strong>Category:</strong></span>
        <span style="color:#b94a48" id="category_help"></span>
        <br/>

        <div class="category_checkboxes row control-group">
          <div class="control-group" id="category_div">
          <fieldset>
            <% catCount=0 %>
            <% rowLimit=5 %>
            <% @categories.each do |cat| %>
              <% if catCount % rowLimit == 0 %>
                <div class="span3">
              <%end%>

              <%= f.label cat.name, {:class=>"radio"} do%>
                <%= f.radio_button :category, "#{cat.name}"%>
              <%= cat.name %>
              <%end%>

              <% if (catCount+1) % rowLimit == 0 %>
                </div>
              <%end%>
              <% catCount += 1 %>
            <%end%>

            <% if catCount % rowLimit != 0 %>
              </div>
            <%end%>
          </fieldset>
        </div>
      </div>

      <div class="control-group">
        <label for="tags"><strong>Tags</strong> (optional)</label> 
        <span class="controls">
          <%= f.text_field :tags,
            {:class=>"model_text",
             :placeholder=>"ex) humanoid, bipedal, mobile manipulator"} %>
        </span>
      </div>

      <span><strong>Model Tarball</strong></span>
      <span style="color:#b94a48" id="file_help"></span>

      <div style="margin-top: 0px; margin-bottom: 4px">
        Select the [model_name].tar.gz file created by the <b>gzprop</b> program.
      </div>

      <span class="btn btn-success fileinput-button">
        <i class="icon-white icon-plus"></i>
        <span>Add</span>
        <%= f.file_field :files, :id=>"select_files" %>
      </span>

      <div style="margin-top: 5px">
        <table class="table table-striped">
          <tbody class="files" data-toggle="modal-gallery"
            data-target="#modal-gallery" id="list"></tbody>
        </table>
      </div>
    </div>

    <div class="span6">
      <h2> Guidelines </h2>
      <ul class="guidelines">
        <li> A model name and description are required. </li>
        <li> Select appropriate tags and categories. </li>
        <li> Select a tarball (.tar.gz file) created by <b>gzprop</b>
        <ul>
          <li> Gazebo must be <a href="http://gazebosim.org/wiki/install">installed</a> on your personal computer.</li>
          <li> Run <b>gzprop &lt;model_directory&gt;</b> to generate a tarball for upload.</li>
          <li> For help, run <b>man gzprop</b> in a terminal.</li>
        </ul>
        <li> All materials will be licensed under <a href="http://creativecommons.org/licenses/by/3.0/" target="_blank">Creative Commons Attribution 3.0.</a></li>
      </ul>
    </div>
  </div>

  <hr style="border: 1px solid #E6E6E6;" />

  <!--Upload/Cancel/Next buttons -->
  <div class="upload_buttons row">
    <div class="span6"> 
      <%= link_to "Cancel", root_path,
        {:class=>("btn")} %>
    </div>
    <div class="span6 next_button"> 
      <%= f.submit "Submit",:class => "upload_buttons btn btn-primary" %>
    </div>
  </div>
</div>

<% end %>

<!--This is the modal for signing up-->
<div id="signin_modal" class="modal hide fade" tabindex="-1" role="dialog"
  aria-labelledby="signin_modal" aria-hidden="true">

  <div class="modal-header">
    <h3 id="myModalLabel">Sign In</h3>
    Sign in using:
  </div>

  <div class='modal-body' style="padding: 10px">
    <%= link_to image_tag("google-icon-32.png", alt:"google"), 
      {:controller=>"sessions", :action=>"new", :auth=>"google",
       :redirect=>"#{request.original_url}"},
      {:style=>"padding-right: 10px"}%>
    <%= link_to image_tag("yahoo-icon-32.png", alt:"yahoo"),
      {:controller=>"sessions", :action=>"new", :auth=>"yahoo",
        :redirect=>"#{request.original_url}"},
      {:style=>"padding-right: 10px"}%>
    <%= link_to image_tag("openid-icon-32.png", alt:"openid"),
      {:controller=>"sessions", :action=>"new", :auth=>"openid",
       :redirect=>"#{request.original_url}"},
      {:style=>"padding-right: 10px"}%>
    <%= link_to image_tag("aol-icon-32.png", alt:"aol"),
      {:controller=>"sessions", :action=>"new", :auth=>"aol",
       :redirect=>"#{request.original_url}"},
      {:style=>"padding-right: 10px"}%>
  </div>
</div>


<script>

  function validateForm()
  {
    var name = document.forms["model_form"]["model[name]"].value;
    var description = document.forms["model_form"]["model[description]"].value;
    var category = ""

    document.getElementById('category_help').innerHTML = "";
    document.getElementById('category_div').className = "control-group";

    document.getElementById('file_help').innerHTML = "";

    var c = document.getElementsByName('model[category]')
    for(var i = 0; i < c.length; i++)
    {
      if (c[i].checked)
      {
        category = c[i].value
      }
    }

    if (category == "")
    {
      document.getElementById('category_div').className += " error";
      document.getElementById('category_help').innerHTML = "Select a category";
      return false;
    }

    var good = false;
    for (var i=0; i < document.getElementById('list').childNodes.length; ++i)
    {
      var id = "filename_"+i.toString();
      var filename = document.getElementById(id);
      if (!filename)
      {
        break;
      }

      var parts = filename.innerHTML.split(".");
      if (parts.length > 1 && parts[parts.length-1] == "gz")
      {
        good = true;
        break;
      }
    }

    if (!good)
    {
      document.getElementById('file_help').innerHTML =
      "Add a model.tar.gz file.";
    }
    return good;
  }

  function cancelFile(_id)
  {
    var elem = document.getElementById(_id);
    elem.parentNode.removeChild(elem);
  }

  function handleFileSelect(evt)
  {
    document.getElementById('file_help').innerHTML = "";

    // FileList object
    var files = evt.target.files;
    var offset = document.getElementById('list').childNodes.length;

    // files is a FileList of File objects. List some properties.
    var output = [];
    for (var i = 0, f; f = files[i]; i++)
    {
      output.push('<tr class="template-upload fade in" id="file',i+offset,'"><td class="preview"><span class="fade"</span></td><td><p id="filename_',i+offset,'">', escape(f.name), '</p></td><td>', (f.size / 1024).toFixed(2), ' KB </td><td><button class="btn btn-warning" onclick="cancelFile(\'file',i+offset,'\')"><i class="icon-white icon-ban-circle"></i></button> <input type="hidden" name="file',i+offset,'" value="', escape(f.name),'"/></td></tr>');
    }
    document.getElementById('list').innerHTML = output.join('');
  }

  document.getElementById('select_files').addEventListener('change',
    handleFileSelect, false);

  <%if !current_user%>
    $('#signin_modal').modal()
    $('#signin_modal').on('hidden.bs.modal', function(){
      window.history.back();
    });

  <%end%>

</script>
